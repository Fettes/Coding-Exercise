## 1. OSI七层模型 
(转载链接：[简书](https://www.jianshu.com/p/0125d110e3bb))
|  OSI模型  | 对应协议           |
| -------- |------------------- |
应用层(Application) | HTTP,TFTP; FTP; NFS; WAIS, SMTP
表示层(Presentation) | Telnet, Rlogin, SNMP, Gopher
会话层(Session) | SMTP, DNS
传输层(Transport) | TCP, UDP
网络层(Network) | IP, ICMP, ARP, RARP, AKP, UUCP
数据链路层(Data Link) | FDDI, Ethernet, Arpanet, PDN, SLIP, PPP
物理层(Physical) | IEEE 802.1A, IEEE 802.2到IEEE 802.11

### 1.1 物理层
在OSI参考模型中，物理层（Physical Layer）是参考模型的最低层，也是OSI模型的第一层。

物理层的功能：利用传输介质为数据链路层提供物理连接，实现比特流的传输。

物理层的作用：物理层的作用是实现相邻计算机节点之间**比特流的透明传送**，尽可能屏蔽掉具体传输介质和物理设备的差异。使其上面的数据链路层不必考虑网络的具体传输介质是什么。

> “透明传送比特流”表示经实际电路传送后的比特流没有发生变化，对传送的比特流来说，这个电路好像是看不见的
> 
> 把二进制转换成电流，把电流转换成二进制（单位是bit比特）
> 
> 与物理层有关的设备：中继器（将电信号方法，因为电缆是金属有电阻）

### 1.2 数据链路层
数据链路层（Data Link Layer）是OSI模型的第二层，负责建立和管理节点间的链路。该层的主要功能是：通过各种控制协议，将有差错的物理信道变为无差错的、能可靠传输数据帧的数据链路。

在计算机网络中由于各种干扰的存在，物理链路是不可靠的。因此，这一层的主要功能是在物理层提供的比特流的基础上，通过**差错控制、流量控制**方法，使有差错的物理线路变为无差错的数据链路，即提供可靠的通过物理介质传输数据的方法。

数据链路层的具体工作是：接收来自物理层的位流形式的数据，并封装成帧，传送到上一层；同样，也将来自上层的数据帧，拆装为位流形式的数据转发到物理层。

将二进制数据转换成标准帧格式（起始位、数据、地址、校验、结束位）

与数据链路层有关的设备：交换机，也就是大家常说的猫（为数据帧从一个端口到另一个任意端口的转发提供了低时延、低开销的通路）

>如果把电脑比如成客户，数据链路比喻成物流，那么快递小哥如何找到客户地址？
>
>答：通过电脑MAC地址（MAC地址由网卡决定）

### 1.3 网络层
网络层（Network Layer）是OSI模型的第三层，它是OSI参考模型中最复杂的一层，也是**通信子网的最高一层**。它在下两层的基础上向资源子网提供服务。其主要任务是：通过路由选择算法，为报文或分组通过通信子网选择最适当的路径。该层控制**数据链路层**与**传输层**之间的信息转发，**建立、维持和终止网络的连接**。具体地说，数据链路层的数据在这一层被转换为数据包，然后通过路径选择、分段组合、顺序、进/出路由等控制，将信息从一个网络设备传送到另一个网络设备。

寻址：数据链路层中使用的物理地址（如MAC地址）仅解决网络内部的寻址问题。在不同子网之间通信时，为了识别和找到网络中的设备，每一子网中的设备都会被分配一个唯一的地址。由于各子网使用的物理技术可能不同，因此这个地址应当是**逻辑地址（如IP地址）**。

交换：规定不同的信息交换方式。常见的交换技术有：线路交换技术和存储转发技术，后者又包括报文交换技术和分组交换技术。

路由算法：当源节点和目的节点之间存在多条路径时，本层可以根据路由算法，通过网络为数据分组选择最佳路径，并将信息从最合适的路径由发送端传送到接收端。

连接服务：与数据链路层流量控制不同的是，前者控制的是网络相邻节点间的流量，后者控制的是从源节点到目的节点间的流量。其目的在于防止阻塞，并进行差错检测。

网络层有关的设备：**路由器**（一个作用是连通不同的网络，另一个作用是选择信息传送的线路）

>1.网络层主要有两个作用:
>   - 选择数据传输的最优路径，解决网络阻塞问题（网络阻塞的原因主要是CPU需要处理数据有一定延迟）
>   - 将大的数据切割成小的数据包，根据不同时间段的不同最优路径进行传输（可以联想看片时候的断点续传）
>
>2.互联网如何识别电脑？
>
>答: 通过ip地址

### 1.4 传输层
OSI下3层的主要任务是**数据通信**，上3层的任务是**数据处理**。而传输层（Transport Layer）是OSI模型的第4层。因此该层是通信子网和资源子网的接口和桥梁，起到承上启下的作用。

该层的主要任务是：定义了一些传输数据的协议和端口号（如HTTP的端口80等），TCP（传输控制协议，传输效率低，可靠性强，可以用于传输可靠性要求高，数据量大的数据），UDP（用户数据报协议，与TCP特性恰恰相反，用于传输可靠性要求不高，数据量小的数据，如QQ聊天数据就是通过这种方式传输的）。 主要是从下层接收的数据进行分段和传输，到达目的地址后再进行重组。常常把这一层数据叫做报文段(Message Segment)。

>1.**协议和端口号是在传输层定义的**
>
>2.电脑如何识别某一个应用程序？
>
>答：通过端口号：每一个应用程序都有很多的服务，每一个服务对应着一个端口号
>
>3.MAC地址、ip地址、端口号的理解
>
>答：假如我想在淘宝买一个娃娃，首先需要登录淘宝账号，下单购买后卖家开始联系寄东西过来。如果把卖家比喻成电脑A，我比喻成电脑B，买的东西相当于A给B传输的数据，那么MAC地址就相当于B下单时填写的收货地址，这个地址是固定的，如果搬家了换了地址就相当于换了网卡更换了MAC地址，而ip地址就相当淘宝这个平台，我可以在淘宝买东西，也可以在京东买，ip地址是不固定的，端口号就相当于学校有很多楼也有很多教室，每一个教室对应的是一个端口号（好比用淘宝程序购买，虽然找到了这台电脑的地址但是电脑中有很多应用程序，如何找到你是用淘宝客户端发起的获取数据请求而不是你的其他软件就是通过端口号来识别的）


### 1.5 会话层
会话层（Session Layer）是OSI模型的第5层，是用户应用程序和网络之间的接口，主要任务是：向两个实体的表示层提供建立和使用连接的方法。将不同实体之间的表示层的连接称为会话。因此会话层的任务就是组织和协调两个会话进程之间的通信，并对数据交换进行管理。

通过传输层（端口号：传输端口与接收端口）建立数据传输的通路。主要在你的系统之间发起会话或者接受会话请求（设备之间需要互相认识可以是IP也可以是MAC或者是主机名）。

**数据的传输是在会话层完成的，而不是传输层**，传输层只是定义了数据传输的协议。

在这层我们可以将小心进行加密，如：Transport Layer Security（传输层安全协定）。

### 1.6 表示层
表示层（Presentation Layer）是OSI模型的第六层，它对来自应用层的命令和数据进行解释，对各种语法赋予相应的含义，并按照一定的格式传送给会话层。其主要功能是“处理用户信息的表示问题，如编码、数据格式转换和加密解密”等

可确保一个系统的应用层所发送的信息可以被另一个系统的应用层读取。例如，PC程序与另一台计算机进行通信，其中一台计算机使用扩展二一十进制交换码（EBCDIC），而另一台则使用美国信息交换标准码（ASCII）来表示相同的字符。如有必要，表示层会通过使用一种通格式来实现多种数据格式之间的转换。

表示层的任务：**数据格式转换**（可以理解成iOS中将c语言的char字符转换成OC语言的NSString）

### 1.7 应用层
应用层（Application Layer）是OSI参考模型的最高层，它是计算机用户，以及各种应用程序和网络之间的接口，其功能是直接向用户提供服务，完成用户希望在网络上完成的各种工作

是最靠近用户的OSI层。这一层为用户的应用程序（例如电子邮件、文件传输和终端仿真）提供网络服务。 


## 2. TCP/IP的四层协议
![TCP/IP](../Assets/tcpip_1.jpg)

网络接口层(Network Access Layer)：处理数据在媒介上的表示、传输以及与硬件交互的细节。

包括用于协作IP数据在已有网络介质上传输的协议。实际上TCP/IP标准并不定义与OSI数据链路层和物理层相对应的功能。相反，它定义像地址解析协议(Address Resolution Protocol,ARP)这样的协议，提供TCP/IP协议的数据结构和实际物理硬件之间的接口。

网络层：IP层负责IP数据报的路由转发，所有的TCP、UDP、ICMP和IGMP数据都通过IP数据报传输。网络层（IP）提供了一种尽力而为、无连接、不可靠的数据报交付服务，IP负责将IP数据报（又叫分组），放入数据链路层传输，负责分片和重组逻辑。

本层包含IP协议、RIP协议(Routing Information Protocol，路由信息协议)，负责数据的包装、寻址和路由。同时还包含网间控制报文协议(Internet Control Message Protocol,ICMP)用来提供网络诊断信息。

传输层：为端主机上运行的应用程序提供端到端服务，包括TCP和UDP。TCP提供了带流量控制、拥塞控制、有序、可靠的流交付，TCP需要处理丢包检测重传、重排序等IP层不处理的问题，TCP面向连接，不保留消息边界；而UDP提供的功能基本上没有超越IP，不提供速率控制和差错控制，不保证可靠性，UDP只是提供一套端口号，用于复用、多路分解（即把收到的UDP数据报交给应用层对应程序处理）和校验数据完整性（只检错不纠错），UDP面向非连接，保留消息边界。

提供两种端到端的通信服务。其中TCP协议(Transmission Control Protocol)提供可靠的数据流运输服务，UDP协议(Use Datagram Protocol)提供不可靠的用户数据报服务。

应用层：负责处理特定应用的细节，通常应用的实现都是基于TCP/IP或者UDP/IP。应用层与应用细节相关，与网络数据传输无关，而之下的三层（链路层、网络层、传输层）则对应用一无所知，但需要处理通信的细节。

因特网的应用层协议包括Finger、Whois、FTP(文件传输协议)、Gopher、HTTP(超文本传输协议)、Telent(远程终端协议)、SMTP(简单邮件传送协议)、IRC(因特网中继会话)、NNTP（网络新闻传输协议）等。

## 3. 各层对应设备

- 中继器：物理层（在比特级别对网络信号进行再生和重定时，从而使得它们能够在网络上传输更长的距离）
- 集线器（Hub）：物理层（纯硬件设备，主要用来连接计算机等网络终端）
- 网桥：数据链路层（将两个LAN连起来，根据MAC地址来转发帧）
- 交换机：数据链路层、网络层（识别数据包中的MAC地址信息，根据MAC地址进行转发，并将这些MAC地址与对应的端口记录在自己内部的一个地址表中）
- 路由器：网络层（路由选择、存储转发）
- 网关：应用层、传输层（网关在传输层上以实现网络互连，是最复杂的网络互连设备，仅用于两个高层协议不同的网络互连。网关的结构也和路由器类似，不同的是互连层。网关既可以用于广域网互连，也可以用于局域网互连）

>不同点：
>
>首先说HUB,也就是集线器。它的作用可以简单的理解为将一些机器连接起来组成一个局域网。
>
>而交换机（又名交换式集线器）作用与集线器大体相同。但是两者在性能上有区别：集线器采用的式共享带宽的工作方式，而交换机是独享带宽。这样在机器很多或数据量很大时，两者将会有比较明显的。
>
>而路由器与以上两者有明显区别，它的作用在于连接不同的网段并且找到网络中数据传输最合适的路径。路由器是产生于交换机之后，就像交换机产生于集线器之后，所以路由器与交换机也有一定联系，不是完全独立的两种设备。路由器主要克服了交换机不能路由转发数据包的不足。

## 4. 各层协议基础

### 4.1 传输层协议

#### 4.1.1 TCP协议，报文格式
<img src="../Assets/tcp_1.png" width="500">
<img src="../Assets/tcp_2.png" width="500">

- 序号：用于对字节流进行编号，例如序号为 301，表示第一个字节的编号为 301，如果携带的数据长度为 100 字节，那么下一个报文段的序号应为 401。

- 确认号：期望收到的下一个报文段的序号。例如 B 正确收到 A 发送来的一个报文段，序号为 501，携带的数据长度为 200 字节，因此 B 期望下一个报文段的序号为 701，B 发送给 A 的确认报文段中确认号就为 701。

- 数据偏移：指的是数据部分距离报文段起始处的偏移量，实际上指的是首部的长度。

- 控制位：八位从左到右分别是 CWR，ECE，URG，ACK，PSH，RST，SYN，FIN。

>CWR：CWR 标志与后面的 ECE 标志都用于 IP 首部的 ECN 字段，ECE 标志为 1 时，则通知对方已将拥塞窗口缩小；
>
>ECE：若其值为 1 则会通知对方，从对方到这边的网络有阻塞。在收到数据包的 IP 首部中 ECN 为 1 时将 TCP 首部中的 ECE 设为 1；
>
>URG：该位设为 1，表示包中有需要紧急处理的数据，对于需要紧急处理的数据，与后面的紧急指针有关；
>
>ACK：该位设为 1，确认应答的字段有效，TCP规定除了最初建立连接时的 SYN 包之外该位必须设为 1；
>
>PSH：该位设为 1，表示需要将收到的数据立刻传给上层应用协议，若设为 0，则先将数据进行缓存；
>
>RST：该位设为 1，表示 TCP 连接出现异常必须强制断开连接；
>
>SYN：用于建立连接，该位设为 1，表示希望建立连接，并在其序列号的字段进行序列号初值设定；
>
>FIN：该位设为 1，表示今后不再有数据发送，希望断开连接。当通信结束希望断开连接时，通信双方的主机之间就可以相互交换 FIN 位置为 1 的 TCP 段。
>
>每个主机又对对方的 FIN 包进行确认应答之后可以断开连接。不过，主机收到 FIN 设置为 1 的 TCP 段之后不必马上回复一个 FIN 包，而是可以等到缓冲区中的所有数据都因为已成功发送而被自动删除之后再发 FIN 包；

- 窗口：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。

- 检验和：TCP报头中有对应的检验和字段，发送的数据包的二进制相加然后取反，目的是检测数据在传输过程中的任何变化。如果收到段的检验和有差错，TCP将丢弃这个报文段和不确认收到此报文段。

### 4.1.2 UDP协议，报文格式

![udp](../Assets/udp_1.png)

### 4.1.3 TCP/UDP 的区别

- 用户数据报协议 UDP（User Datagram Protocol）

    是无连接的，尽最大可能交付，没有拥塞控制，面向报文（对于应用程序传下来的报文不合并也不拆分，只是添加 UDP 首部），支持一对一、一对多、多对一和多对多的交互通信。虽然UDP不提供可靠交付，但在某些情况下UDP确是一种最有效的工作方式（一般用于即时通信），比如： QQ语音, QQ视频, 直播等等

    对应协议：
    1.  DNS：用于域名解析服务，将域名地址转换为IP地址。DNS用的是53号端口。
    2.  SNMP：简单网络管理协议，使用161号端口，是用来管理网络设备的。由于网络设备很多，无连接的服务就体现出其优势。
    3.  TFTP(Trival File Tranfer Protocal)，简单文件传输协议，该协议在熟知端口69上使用UDP服务。

- 传输控制协议 TCP（Transmission Control Protocol）

    是面向连接的，提供可靠交付，有流量控制，拥塞控制，提供全双工通信，面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块），每一条 TCP 连接只能是点对点的（一对一）。TCP一般用于文件传输、发送和接收邮件、远程登录等场景。

    对应协议：
    1.  FTP：定义了文件传输协议，使用21端口。
    2.  Telnet：一种用于远程登陆的端口，使用23端口，用户可以以自己的身份远程连接到计算机上，可提供基于DOS模式下的通信服务。
    3.  SMTP：邮件传送协议，用于发送邮件。服务器开放的是25号端口。
    4.  POP3：它是和SMTP对应，POP3用于接收邮件。POP3协议所用的是110端口。
    8.  HTTP：是从Web服务器传输超文本到本地浏览器的传送协议。

总结：

UDP的主要特点：
- UDP是无连接的；
- UDP使用尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的链接状态（这里面有许多参数）；
- UDP是面向报文的；
- UDP没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低（对实时应用很有用，如IP电话，实时视频会议等）；
- UDP支持一对一、一对多、多对一和多对多的交互通信；
- UDP的首部开销小，只有8个字节，比TCP的20个字节的首部要短。

TCP的主要特点：

- TCP是面向连接的。（就好像打电话一样，通话前需要先拨号建立连接，通话结束后要挂机释放连接）；
- 每一条TCP连接只能有两个端点，每一条TCP连接只能是点对点的（一对一）；
- TCP提供可靠交付的服务。通过TCP连接传送的数据，无差错、不丢失、不重复、并且按序到达；
- TCP提供全双工通信。TCP允许通信双方的应用进程在任何时候都能发送数据。TCP连接的两端都设有发送缓存和接收缓存，用来临时存放双方通信的数据；
- 面向字节流。TCP中的“流”（stream）指的是流入进程或从进程流出的字节序列。“面向字节流”的含义是：虽然应用程序和TCP的交互是一次一个数据块（大小不等），但TCP把应用程序交下来的数据仅仅看成是一连串的无结构的字节流。








